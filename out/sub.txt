# precombat
apply_poison
flask
augmentation
food
snapshot_stats
var priority_rotation = priority_rotation
var trinket_sync_slot = 1 if trinket.1.has_stat.any_dps & (!trinket.2.has_stat.any_dps | trinket.1.cooldown.duration >= trinket.2.cooldown.duration)
var trinket_sync_slot = 2 if trinket.2.has_stat.any_dps & (!trinket.1.has_stat.any_dps | trinket.2.cooldown.duration > trinket.1.cooldown.duration)
var trinket_sync_slot = 1 if trinket.1.is.treacherous_transmitter
stealth

# actions
stealth
kick
var snd_condition = slice_and_dice.up
call_action_list,name = cds
call_action_list,name = items if trinket_sync_slot = 1
slice_and_dice if combo_points >= 1 & !snd_condition
run_action_list,name = stealthed if stealthed.all
call_action_list,name = stealth_cds
call_action_list,name = finish if darkest_night.up & combo_points =  = cp_max_spend
call_action_list,name = finish if cp >= cp_max_spend & !darkest_night.up
call_action_list,name = finish if (combo_points.deficit <= 1 + talent.deathstalkers_mark | fight_remains <= 1 & cp >= 3) & !darkest_night.up
call_action_list,name = build if energy.deficit <= 20 + talent.vigor.rank * 25 + talent.thistle_tea * 20 + talent.shadowcraft * 20
arcane_torrent if energy.deficit >= 15 + energy.regen
arcane_pulse
lights_judgment
bag_of_tricks

# build
shuriken_storm if targets >= 2 + (talent.gloomblade & lingering_shadow.remains >= 6 | perforated_veins.up) & (flawless_form.up | !talent.unseen_blade)
shuriken_storm if clear_the_witnesses.up & (!symbols_of_death.up | !talent.inevitability) & (lingering_shadow.remains <= 6 | !talent.lingering_shadow)
gloomblade
backstab

# cds
var ruptures_before_flag = targets <= 4 | talent.invigorating_shadowdust & !talent.follow_the_blood | (talent.replicating_shadows & (targets >= 5 & active_rupture >= targets - 2)) | !talent.replicating_shadows
cold_blood if !talent.secret_technique & combo_points >= 6
sepsis if snd_condition & (cooldown.shadow_blades.remains <= 3 & cooldown.symbols_of_death.remains <= 3 | fight_remains <= 12)
flagellation,target_if = max:target.time_to_die if snd_condition & ruptures_before_flag & combo_points >= 6 & target.time_to_die > 10 & (cooldown.shadow_blades.remains <= 2 | fight_remains <= 24) & (!talent.invigorating_shadowdust | cooldown.symbols_of_death.remains <= 3 | symbols_of_death.remains > 3)
symbols_of_death if !talent.invigorating_shadowdust & snd_condition & (shadow_blades.up | cooldown.shadow_blades.remains > 20)
symbols_of_death if talent.invigorating_shadowdust & snd_condition & symbols_of_death.remains <= 3 & !the_rotten.up & (cooldown.flagellation.remains > 10 | cooldown.flagellation.up & cooldown.shadow_blades.remains >= 20 | shadow_dance.remains >= 2)
shadow_blades if snd_condition & combo_points <= 1 & (flagellation_up | !talent.flagellation) | fight_remains <= 20
echoing_reprimand if snd_condition & combo_points.deficit >= 3 & (!talent.the_rotten | !talent.reverberation | shadow_dance.up)
shuriken_tornado if snd_condition & symbols_of_death.up & combo_points <= 2 & !premeditation.up & (!talent.flagellation | cooldown.flagellation.remains > 20) & targets.shuriken_storm >= 3
shuriken_tornado if snd_condition & !shadow_dance.up & !flagellation_up & !flagellation_persist.up & !shadow_blades.up & targets.shuriken_storm <= 2 & !raid_event.adds.up
vanish if shadow_dance.up & talent.invigorating_shadowdust & talent.unseen_blade & (combo_points.deficit > 1) & (cooldown.flagellation.remains >= 60 | !talent.flagellation | fight_remains <= (30 * cooldown.vanish.charges)) & cooldown.secret_technique.remains >= 10
shadow_dance if !shadow_dance.up & fight_remains <= 8 + talent.subterfuge.enabled
shadow_dance if !shadow_dance.up & talent.invigorating_shadowdust & talent.deathstalkers_mark & shadow_blades.up & (subterfuge.up & targets >= 4 | subterfuge.remains >= 3)
shadow_dance if !shadow_dance.up & talent.unseen_blade & talent.invigorating_shadowdust & rupture.ticking & snd_condition & (symbols_of_death.remains >= 6 & !flagellation_up | symbols_of_death.up & shadow_blades.up | shadow_blades.up & !talent.invigorating_shadowdust) & (cooldown.secret_technique.remains < 10 + 12 * !talent.invigorating_shadowdust | shadow_blades.up) & (!talent.the_first_dance | (combo_points.deficit >= 7 & !shadow_blades.up | shadow_blades.up))
goremaws_bite if snd_condition & combo_points.deficit >= 3 & (!cooldown.shadow_dance.up | talent.double_dance & shadow_dance.up & !talent.invigorating_shadowdust | targets.shuriken_storm < 4 & !talent.invigorating_shadowdust | talent.the_rotten | raid_event.adds.up)
thistle_tea if !thistle_tea.up & (shadow_dance.remains >= 4 & shadow_blades.up | shadow_dance.remains >= 4 & cooldown.cold_blood.remains <= 3) | fight_remains <= (6 * cooldown.thistle_tea.charges)
potion if bloodlust.react | fight_remains < 30 | symbols_of_death.up & (shadow_blades.up | cooldown.shadow_blades.remains <= 10)
var racial_sync = shadow_blades.up | !talent.shadow_blades & symbols_of_death.up | fight_remains < 20
blood_fury if racial_sync
berserking if racial_sync
fireblood if racial_sync & shadow_dance.up
ancestral_call if racial_sync
invoke_external_buff,name = power_infusion if shadow_dance.up

# finish
var secret_condition = !darkest_night.up & (danse_macabre.stack >= 2 | !talent.danse_macabre | (talent.unseen_blade & shadow_dance.up & escalating_blade.stack >= 2))
rupture if !rupture.ticking & target.time_to_die - remains > 6
var skip_rupture = thistle_tea.up & targets.shuriken_storm = 1 | shadow_dance.up & (targets.shuriken_storm = 1 | rupture.ticking & targets.shuriken_storm >= 2) | darkest_night.up
rupture if (!skip_rupture | priority_rotation) & target.time_to_die - remains > 6 & refreshable
coup_de_grace if fazed.up & (shadow_dance.up | (symbols_of_death.up & cooldown.shadow_dance.charges_fractional <= 0.85))
cold_blood if secret_condition & cooldown.secret_technique.ready
secret_technique if secret_condition & (!talent.cold_blood | cooldown.cold_blood.remains > shadow_dance.remains - 2 | !talent.improved_shadow_dance)
rupture,cycle_targets = 1 if !skip_rupture & !priority_rotation & targets.shuriken_storm >= 2 & target.time_to_die >= (2 * combo_points) & refreshable
rupture if !skip_rupture & finality_rupture.up & (cooldown.symbols_of_death.remains <= 3 | symbols_of_death.up)
black_powder if !priority_rotation & talent.deathstalkers_mark & targets >= 3 & !darkest_night.up
black_powder if !priority_rotation & talent.unseen_blade & ((escalating_blade.stack = 4 & !shadow_dance.up) | targets >= 3 & !flawless_form.up | targets > 10 | (!used_for_danse & shadow_dance.up & talent.shuriken_tornado & targets >= 3))
coup_de_grace if fazed.up
eviscerate

# items
use_item,name = treacherous_transmitter if shadow_blades.up | fight_remains <= 15
do_treacherous_transmitter_task if shadow_blades.up | fight_remains <= 15
use_item,name = imperfect_ascendancy_serum,use_off_gcd = 1 if rupture.ticking & flagellation_up
use_items,slots = trinket1 if (trinket_sync_slot = 1 & (shadow_blades.up | (1 + cooldown.shadow_blades.remains) >= trinket.1.cooldown.duration | fight_remains <= 20) | (trinket_sync_slot = 2 & (!trinket.2.cooldown.ready & !shadow_blades.up & cooldown.shadow_blades.remains > 20)) | !trinket_sync_slot)
use_items,slots = trinket2 if (trinket_sync_slot = 2 & (shadow_blades.up | (1 + cooldown.shadow_blades.remains) >= trinket.2.cooldown.duration | fight_remains <= 20) | (trinket_sync_slot = 1 & (!trinket.1.cooldown.ready & !shadow_blades.up & cooldown.shadow_blades.remains > 20)) | !trinket_sync_slot)

# stealth_cds
vanish if !talent.invigorating_shadowdust & !talent.subterfuge & combo_points.deficit >= 3 & (!rupture.ticking | (shadow_blades.up & symbols_of_death.up) | talent.premeditation | fight_remains < 10)
vanish if !shadow_dance.up & talent.invigorating_shadowdust & talent.deathstalkers_mark & (combo_points.deficit > 1 | shadow_blades.up) & (cooldown.flagellation.remains >= 60 | !talent.flagellation | fight_remains <= (30 * cooldown.vanish.charges)) & cooldown.secret_technique.remains >= 10
shadow_dance if rupture.ticking & snd_condition & (symbols_of_death.remains >= 6 & !flagellation_up | symbols_of_death.up & shadow_blades.up | shadow_blades.up & !talent.invigorating_shadowdust) & cooldown.secret_technique.remains < 10 + 12 * !talent.invigorating_shadowdust & (!talent.the_first_dance | (combo_points.deficit >= 7 & !shadow_blades.up | shadow_blades.up))
vanish if !talent.invigorating_shadowdust & talent.subterfuge & combo_points.deficit >= 3 & (symbols_of_death.up | cooldown.symbols_of_death.remains >= 3)
shadowmeld if energy >= 40 & combo_points.deficit > 3

# stealthed
shadowstrike if talent.deathstalkers_mark & !deathstalkers_mark.up & !darkest_night.up
call_action_list,name = finish if darkest_night.up & combo_points =  = cp_max_spend
call_action_list,name = finish if cp >= cp_max_spend & !darkest_night.up
call_action_list,name = finish if shuriken_tornado.up & combo_points.deficit <= 2 & !darkest_night.up
call_action_list,name = finish if (combo_points.deficit <= 1 + talent.deathstalkers_mark) & !darkest_night.up
shadowstrike if (!used_for_danse & shadow_blades.up) | (talent.unseen_blade & targets >= 2)
shuriken_storm if !premeditation.up & targets >= 4
gloomblade if lingering_shadow.remains >= 10 & shadow_blades.up & targets = 1
shadowstrike

